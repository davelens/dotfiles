#!/usr/bin/env bash
set -e
[[ -f ~/.bash/commands ]] && . ~/.bash/commands

# TODO: Proper Rails Engine support

# So we know what command was run. $DAVE_COMMAND is set in bin/dave.
CMD="${DAVE_COMMAND:-$(basename "$0")}"

[[ ! -f config.ru && ! -f spec/dummy/config.ru ]] && fail "[$CMD] ERROR: You can only run this from a folder containing a Rails project."

cmd='bundle exec rake'
task=migrate
[[ -f config/cable.yml ]] && cmd='bundle exec rails' # Rails 5+
[[ $# -eq 1 && $1 == '-r' ]] && task=rollback # Rollback requested by option
[[ -x bin/bundle ]] && cmd=bin/$cmd

$cmd db:$task
$cmd db:$task RAILS_ENV=test
