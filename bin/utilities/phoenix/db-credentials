#!/usr/bin/env bash

# Lookup database credentials from a Phoenix project's config files.
#
# Usage:
#   utility phoenix db-credentials                  # dump all keys for dev
#   utility phoenix db-credentials -p               # dump all keys for prod
#   utility phoenix db-credentials --key=database   # lookup single key
#   utility phoenix db-credentials --key=database --app=/path/to/app


# NOTE: I started writing this in Elixir, but I was approaching 200 lines.
# I'm not good enough with Elixir yet to pull this off succinctly, so in the
# mean time here's the less-reliable Bash variant.

set -euo pipefail

ME="phoenix/$(basename "$0")"
APP_PATH="."
PHOENIX_ENV="dev"
KEY=""

usage() {
  cat <<EOF
Usage: utility phoenix $(basename "$0") [--key=NAME] [options]

Options:
  --app=PATH    Path to Phoenix application (default: current directory)
  --key=NAME    Credential key to lookup (omit to dump all keys)
  -t, --test    Use test environment
  -s, --staging Use staging environment
  -p, --prod    Use prod environment
  -h, --help    Show this help message
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --app=*) APP_PATH="${1#*=}"; shift ;;
    --key=*) KEY="${1#*=}"; shift ;;
    -t|--test) PHOENIX_ENV="test"; shift ;;
    -s|--staging) PHOENIX_ENV="staging"; shift ;;
    -p|--prod) PHOENIX_ENV="prod"; shift ;;
    -h|--help) usage; exit 0 ;;
    *) echo "[$ME] ERROR: Unknown option '$1'" >&2; usage; exit 1 ;;
  esac
done

APP_PATH=$(cd "$APP_PATH" && pwd)
CONFIG_FILE="$APP_PATH/config/$PHOENIX_ENV.exs"

[[ -f "$APP_PATH/mix.exs" ]] || { echo "[$ME] ERROR: No mix.exs found. Run from a Phoenix project." >&2; exit 1; }
[[ -f "$CONFIG_FILE" ]] || { echo "[$ME] ERROR: No config/$PHOENIX_ENV.exs found." >&2; exit 1; }

# Extract Repo config block and parse key: value pairs
parse_credentials() {
  gsed -n '/\.Repo,/,/^$/p' "$CONFIG_FILE" \
    | { grep -E '^\s+\w+:' || true; } \
    | gsed -E '
        # Extract key and value, handling System.get_env("VAR", "default")
        s/^\s*(\w+):\s*System\.get_env\("[^"]*",\s*"([^"]*)"\).*/\1 \2/
        t
        # Simple quoted string
        s/^\s*(\w+):\s*"([^"]*)".*/\1 \2/
        t
        # Simple value (number, boolean, atom)
        s/^\s*(\w+):\s*([^,]+),?$/\1 \2/
      '
}

credentials=$(parse_credentials)

[[ -z "$credentials" ]] && { echo "[$ME] ERROR: No Repo config found for '$PHOENIX_ENV'." >&2; exit 1; }

if [[ -n "$KEY" ]]; then
  value=$(echo "$credentials" | awk -v key="$KEY" '$1 == key { print $2 }')
  [[ -z "$value" ]] && { echo "[$ME] ERROR: Key '$KEY' not found in $PHOENIX_ENV config." >&2; exit 1; }
  echo "$value"
else
  # Find max key length for padding
  max_len=$(echo "$credentials" | awk '{ if (length($1) > max) max = length($1) } END { print max }')
  echo "$credentials" | awk -v max="$max_len" '{ printf "%-*s  %s\n", max, $1, $2 }'
fi
