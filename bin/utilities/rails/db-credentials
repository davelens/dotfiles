#!/usr/bin/env ruby
# frozen_string_literal: true

# Lookup database credentials from a Rails project's config/database.yml.
# Parses ERB and YAML, handling anchors/aliases.
#
# Usage:
#   utility rails db-credentials                  # dump all keys for development
#   utility rails db-credentials -p               # dump all keys for production
#   utility rails db-credentials --key=database   # lookup single key
#   utility rails db-credentials --key=database --app=/path/to/app
#   utility rails db-credentials --key=database --production

require 'yaml'
require 'erb'
require 'optparse'

ME = "rails/#{File.basename(__FILE__)}"

options = {
  env: 'development',
  key: nil,
  app: '.'
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: utility rails #{File.basename(__FILE__)} [--key=NAME] [options]"

  opts.on('--app=PATH', 'Path to Rails application (default: current directory)') do |v|
    options[:app] = v
  end

  opts.on('--key=NAME', 'Credential key to lookup (omit to dump all keys)') do |v|
    options[:key] = v
  end

  opts.on('-t', '--test', 'Use test environment') do
    options[:env] = 'test'
  end

  opts.on('-s', '--staging', 'Use staging environment') do
    options[:env] = 'staging'
  end

  opts.on('-p', '--production', 'Use production environment') do
    options[:env] = 'production'
  end

  opts.on('-h', '--help', 'Show this help message') do
    puts opts
    exit
  end
end

begin
  parser.parse!
rescue OptionParser::InvalidOption => e
  warn "[#{ME}] ERROR: #{e.message}"
  warn parser.banner
  exit 1
end

app_path = File.expand_path(options[:app])

unless File.exist?(File.join(app_path, 'config.ru'))
  warn "[#{ME}] ERROR: You can only run this from a folder containing a Rails project."
  exit 1
end

file_path = File.join(app_path, 'config/database.yml')

unless File.exist?(file_path)
  warn "[#{ME}] ERROR: No #{file_path.sub(Dir.home, '~')} file found."
  exit 1
end

begin
  config = YAML.load(ERB.new(File.read(file_path)).result, aliases: true)
rescue StandardError => e
  warn "[#{ME}] ERROR: Failed to parse database.yml: #{e.message}"
  exit 1
end

env_config = config[options[:env]]

if env_config.nil?
  warn "[#{ME}] ERROR: No config values for environment '#{options[:env]}' found."
  exit 1
end

if options[:key]
  value = env_config[options[:key]]

  if value.nil?
    warn "[#{ME}] ERROR: Key '#{options[:key]}' not found in #{options[:env]} configuration."
    exit 1
  end

  puts value
else
  max_key_length = env_config.keys.map(&:length).max
  env_config.each do |key, value|
    puts "#{key.ljust(max_key_length)}  #{value}"
  end
end
