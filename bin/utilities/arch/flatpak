#!/usr/bin/env bash
set -e
source "$(dirname "${BASH_SOURCE[0]}")"/helpers.sh

UPDATE=false

install_from_file() {
  local file="$1"

  if [[ ! -f "$file" ]]; then
    echo "Error: File not found: $file" >&2
    exit 1
  fi

  local packages
  mapfile -t packages < <(read_packages "$file")

  if [[ ${#packages[@]} -eq 0 ]]; then
    echo "No packages found in $file"
    exit 0
  fi

  [[ "$UPDATE" == true ]] && flatpak update -y
  flatpak --user install -y --noninteractive flathub "${packages[@]}"
}

usage() {
  echo "Usage: $(basename "$0") [OPTIONS]"
  echo
  echo "Options:"
  echo "  --install-from-file <file>  Install packages listed in the given file"
  echo "  --update                    Run flatpak update before installing packages"
  echo "  -h, --help                  Show this help message"
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
  --update)
    UPDATE=true
    shift
    ;;
  --install-from-file)
    [[ -z "$2" ]] && echo "Error: No file specified" >&2 && exit 1
    install_from_file "$2"
    exit 0
    ;;
  -h | --help)
    usage
    ;;
  *)
    usage
    ;;
  esac
done

usage
