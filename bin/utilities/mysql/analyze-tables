#!/usr/bin/env bash
set -e

# Analyzes tables in a MySQL database to refresh index statistics.
# Stale statistics cause the query optimizer to make poor decisions
# (e.g., full table scans instead of index usage).

if [ $# -lt 1 ]; then
  echo
  echo "Usage: utility mysql $(basename "$0") <database>"
  echo
  echo "Runs ANALYZE TABLE on all tables in the database."
  exit 1
fi

database="$1"

tables=$(mysql -N -B -e "SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_SCHEMA = '$database' AND TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_NAME;" 2>/dev/null)

if [ -z "$tables" ]; then
  echo "No tables found in '$database'."
  exit 0
fi

echo "Analyzing tables in '$database'..."
echo

for table in $tables; do
  echo -n "  $table... "
  mysql -e "ANALYZE TABLE \`$database\`.\`$table\`;" >/dev/null 2>&1
  echo "done"
done

echo
echo "Analysis complete. Index statistics have been refreshed."
