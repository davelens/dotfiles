#!/usr/bin/env bash

usage() {
  echo "Usage: utility brew $(basename "$0") [options]"
  echo
  echo "Installs Homebrew and optionally processes Brewfile bundles."
  echo
  echo "Options:"
  echo "  -h, --help          Show this help message and exit."
  echo "  --skip-bundles      Only install Homebrew, skip bundle installation."
}

ensure_brew() {
  if command -v brew >/dev/null; then
    echo "Homebrew is already installed."
  else
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
}

main() {
  set -e

  local skip_bundles=false

  while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
      usage
      exit 0
      ;;
    --skip-bundles)
      skip_bundles=true
      shift
      ;;
    *)
      shift
      ;;
    esac
  done

  ensure_brew

  if [[ "$skip_bundles" == true ]]; then
    exit 0
  fi

  # shellcheck disable=SC2154
  answer=$($prompt_user --yesno "Install brew bundles?")
  if [[ "$answer" == "y" ]]; then
    brew bundle --file="$DOTFILES_REPO_HOME"/setup/brew/Brewfile.default

    if [[ "$(os)" == "macos" ]]; then
      brew bundle --file="$DOTFILES_REPO_HOME"/setup/macos/Brewfile
    fi
  fi
}

# Only run main if executed, not sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
