#!/usr/bin/env bash
set -e

# Gracefully handle Ctrl-C to get out of this thing.
trap 'echo "Aborted."; exit 1' SIGINT

# This command is used to provide suggestions among both my personal as well as
# my work's public and private repositories.

if ! command -v gh &>/dev/null; then
  echo "Error: gh CLI is not installed."
  exit 1
fi

if ! gh auth status &>/dev/null; then
  echo "Error: gh CLI is not authenticated. Run 'gh auth login' first."
  exit 1
fi

usage() {
  echo
  echo "Usage: utility github $(basename "$0") <qualifier>"
  echo
  echo "Options:"
  echo "  -h|--help            Show this help message and exit."
  echo "  -v|--verbose         Enable verbose output."
  echo "  <qualifier>          The Github-specific search qualifier to filter the results."
  echo "                       (e.g. 'Phoenix Framework', 'author:johndoe', 'user:johndoe+user:maryjane', ...)"
  echo
  echo "You can read up on Github search qualifiers for repositories here:"
  echo
  echo "  https://docs.github.com/en/search-github/searching-on-github/searching-for-repositories"
  echo
}

# Fail early if no arguments are given.
[[ $# -eq 0 ]] && usage && exit 1

verbose=false
query=""
page=1
results=()

while [[ $# -gt 0 ]]; do
  case "$1" in
  -h | --help)
    usage && exit 0
    ;;
  -v | --verbose)
    verbose=true
    shift
    ;;
  *)
    query="$1"
    shift
    ;;
  esac
done

# No query, no results.
[[ -z "$query" ]] && usage && exit 1

# Recursively search for repositories.
search() {
  local endpoint="search/repositories?q=${query// /+}&per_page=100&page=$page"

  $verbose && echo "GET $endpoint" >&2

  local repositories
  repositories=$(gh api "$endpoint" --jq '.items[].full_name' 2>/dev/null)

  if [[ -n "$repositories" ]]; then
    results+=("$repositories")

    # Check if we got a full page (might have more results).
    local count
    count=$(echo "$repositories" | wc -l)
    if [[ $count -eq 100 ]]; then
      ((page++))
      search
    fi
  fi
}

echo "Loading repositories..." >&2
search
echo -ne "\033[1A\033[2K" >&2 # Clear the "Loading" line.

# Output results to fzf for selection.
if [[ ${#results[@]} -eq 0 ]]; then
  echo "No repositories found." >&2
  exit 1
fi

printf "%s\n" "${results[@]}" | fzf
