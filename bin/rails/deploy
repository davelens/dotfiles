#!/usr/bin/env bash

# Stops further execution after any error.
set -e

# ~/.bash/commands includes my git_branch function.
[ -f ~/.bash/commands ] && . ~/.bash/commands

env=production

if [ $# -gt 0 ]; then
  if [[ $1 =~ "s" ]]; then
    env=staging
  fi

  if [[ $1 =~ "b" && -n $2 ]]; then
    branch_name=$2
  fi
fi

if [[ -n $branch_name ]]; then
  CMD="bundle exec cap $env deploy BRANCH=$branch_name"
else
  CMD="bundle exec cap $env deploy"
fi

while true; do
  printf "[rails/deploy] I want to run:\n\n"
  printf "  ${CMD}\n\n"
  read -n1 -p "[rails/deploy] Confirm? (y/n) " yn
  echo ""
  case $yn in
    [Yy]* ) eval $CMD; break;;
    [Nn]* ) exit;;
    * ) echo "Please answer `tput smul`Y`tput rmul`es or `tput smul`N`tput rmul`o.";;
  esac
done
