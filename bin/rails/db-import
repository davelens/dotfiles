#!/usr/bin/env bash

set -e
[[ -f ~/.bash/commands ]] && . ~/.bash/commands

[[ ! -f config.ru ]] && fail '[rails/db-import] ERROR: You can only run this from a folder containing a Rails project.'
[[ ! -f config/database.yml ]] && ~/.bin/rails/bootstrap $PWD

function credentials(){
  echo $(~/.bin/rails/lookup-db-credentials $1 $2)
}

env=production
remote_db=$(credentials -p database)
local_db=$(credentials database)
ignore_tables=

# TODO: Be able to override user+host.

for i in "$@"
do
  case $i in
    -i=*|--ignore-data=*)
      ignore_tables="${i#*=}"
      ;;
    -l|--local-database=*)
      local_db="${i#*=}"
      ;;
    -t|--test)
      env=test
      remote_db=$(credentials -t database)
      ;;
    -s|--staging)
      env=staging
      remote_db=$(credentials -s database)
      ;;
    -p|--production)
      env=production
      remote_db=$(credentials -p database)
      ;;
    -r=*|--remote-database=*)
      remote_db="${i#*=}"
      ;;
    *)
      # unknown options
      echo "[rails/db-import] ERROR: Unknown option '${i}'"
      echo "Usage: db-import [-sptrli] [--test] [--staging] [--production]"
      printf "\t[-l=name] [--local-database=name]\n"
      printf "\t[-r=name] [--remote-database=name]\n"
      printf "\t[-i=tables] [--ignore-data=tables]\n"
      exit
      ;;
  esac
done

[[ -z ${local_db} ]] && fail "[rails/db-import] ERROR: No local configuration found in config/database.yml. Aborting."

if [[ -z ${remote_db} ]]; then
  printf "[rails/db-import] WARNING: No configuration for ${env} found in config/database.yml!\n"
  read -p "[rails/db-import] Please enter the name of the remote database: (default: website_prod) " remote_db
  [[ -z ${remote_db} ]] && remote_db="website_prod"
fi

readarray -d , -t ignore_tables <<<"$ignore_tables" # Bash 4.x+

ignored_tables_string=""
for table in "${ignore_tables[@]}"
do :
   ignored_tables_string+=" --ignore-table=${remote_db}.${table}"
done

declare -A ssh_credentials=$(~/.bin/rails/ssh-credentials)
user=${ssh_credentials[user]}
server=${ssh_credentials[server]}

echo "[rails/db-import:${user}@${server}] Dumping ${remote_db}..."
(
ssh ${user}@${server} \
  "mysqldump ${remote_db} --single-transaction --no-data --routines > dump.sql && \
   mysqldump ${remote_db} --no-create-info --skip-triggers ${ignored_tables_string//[$'\t\r\n']} >> dump.sql && tar -cvzf dump.sql.tar dump.sql"
) >/dev/null

echo "[rails/db-import:localhost] Downloading ${user}@${server}:dump.sql.tar"
scp ${user}@${server}:dump.sql.tar .

echo "[rails/db-import:localhost] Unpacking dump.sql.tar"
tar -C . -xvf dump.sql.tar >/dev/null 2>&1

function find_or_create_db() {
  if [[ ! -d $BREW_PATH/var/mysql/$1 ]]; then
    echo "[rails/db-import:localhost] Creating database $1"
    mysql -e "create database $1"
  fi
}

find_or_create_db $local_db
find_or_create_db $(credentials -t database)

echo "[rails/db-import:localhost] Importing dump.sql into ${local_db}"
mysql ${local_db} < dump.sql

echo "[rails/db-import:${user}@${server}] Cleaning up"
ssh ${user}@${server} 'rm -f dump.sql dump.sql.tar'

echo "[rails/db-import:localhost] Cleaning up"
rm -f dump.sql dump.sql.tar
