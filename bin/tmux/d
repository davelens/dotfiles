#!/usr/bin/env bash

# This opens a tmux session with a number of window/pane presets in order to
# do **d**ev work on a project:
#
# * `d`: Will fuzzy find your project in ~/Sites/* using fzf.
# * `d davelens/dotfiles`: Will search ~/Sites/* for the given namespace.
# * `d -q`: Query GitHub to preload repos with fzf to create a local copy.
# * `d -c foo/bar`: Create a new repository for user/org foo and repo name bar.
# * `d -x`: Close opened sessions, using fzf as a selection tool.
#
# It assumes a very specific folder structure; a github repository namespace
# inside the ~/Sites folder. An example:
#
#   ~/Sites/<git-org-or-user>/<git-repo>
#
# All my dev work-related and personal projects reside on GitHub. It makes
# sense for me to follow the same user/repo structure, as it allows me to
# separate my professional projects from my personal ones.
#
# ~/Sites as my top level project folder because I mainly work on webapps, and
# it's the macos default for them.
#
# As an afterthought; Yes, I'm aware of tmuxinator and yes, I've tried it.
# I don't know, I still like a simple bash script better.

set -e
[[ -f ~/.bash/commands ]] && . ~/.bash/commands

# An elegant exit with a fuzzy search to select the namespace to exit.
if [[ $# -eq 1 && $1 == '-x' ]]; then
  tmux kill-session -t $(tmux ls | sed -e 's|:.*||' | fzf)
  exit
fi

# Requesting to pull in a new project will query GitHub's API for namespaces
[[ -n $TMUX ]] && fail 'ERROR: No nested tmux sessions allowed. Detach first, then try again.'

function create_repo() {
  # Check if the repo exists
  # Read this to learn how to suppress a single error with `set -e` active:
  # https://stackoverflow.com/questions/11231937/bash-ignoring-error-for-a-particular-command

  git ls-remote git@github.com:$1.git >/dev/null 2>&1
  if [[ $? -gt 0 ]]; then
    # TODO: https://stackoverflow.com/questions/28385884/how-to-create-repository-in-github-through-github-api#28385929
    which blub
  fi

  # Important because this method gets called in `set --`.
  echo $1
}

# Requesting to pull in a new project will query GitHub's API for namespaces
[[ $# -eq 1 && $1 == '-q' ]] && set -- $(~/.bin/git/github-search-repos user:davelens+user:blimp)
[[ $# -eq 2 && $1 == '-c' ]] && set -- $(create_repo $2)

# Provide a fuzzy search for my projects so I don't have to type names anymore.
[[ -z $1 ]] && set -- $(ls -d ~/Sites/**/* | sed -e "s|`echo ~`/Sites/||" | fzf)

if [[ -z $1 ]]; then
  echo 'ERROR: No project namespace given.'
  printf "\tUsage: d [-x|-n] [<github-user>/<github-repo>]\n" && exit
fi

destination=~/Sites/$1
# Clone the git repo, fail with error output from `git clone`.
[[ ! -d $destination ]] && bootstrap=1 && (git clone git@github.com:$1.git $destination || fail)

function rails_windows() {
  tmux new-window -n db -c $destination -t $1
  tmux new-window -n repl -c $destination -t $1
  tmux new-window -n server -c $destination -t $1
  sleep 1

  if [[ -n `pgrep -n mysqld` ]]; then
    tmux send-keys -t $1:db "clear && mysql \$(~/.bin/rails/lookup-db-credentials database)" C-m
  fi

  tmux send-keys -t $1:server 'export_env_vars_from_file' C-m
  tmux send-keys -t $1:server 'bin/spring server 2>&1 >/dev/null &' C-m
  tmux send-keys -t $1:repl 'export_env_vars_from_file; sleep 2 && clear && bin/rails c' C-m

  case $server in
    [Yy]* ) tmux send-keys -t $1:server 'clear && bin/rails s' C-m;;
    [Nn]* ) tmux send-keys -t $1:server 'clear && bin/rails s';;
    * ) printf "\nPlease answer `tput smul`Y`tput rmul`es or `tput smul`N`tput rmul`o.\n";;
  esac
}

tmux attach -t $1 >/dev/null 2>&1 || (
  tmux new-session -s $1 -n editor -c $destination -d
  tmux send-keys -t $1 "export_env_vars_from_file; clear && vim" C-m

  if [[ -z `pgrep -n mysqld` ]]; then
    read -n1 -p "[tmux/d] Launch local mysql server? (y/n) " mysql
    echo ""
    case $mysql in
      [Yy]* ) mysql.server start >/dev/null 2>&1;;
      [Nn]* ) echo "";;
      * ) printf "\nPlease answer `tput smul`Y`tput rmul`es or `tput smul`N`tput rmul`o.\n";;
    esac
  fi

  if [[ -f $destination/config.ru ]]; then
    read -n1 -p "[tmux/d] Launch local puma server? (y/n) " server
    echo ""
    [[ -n $bootstrap ]] && cd $destination && ~/.bin/rails/db-import -i=logs && cd - >/dev/null
    rails_windows $1
  fi

  tmux attach -d -t $1:1
)
