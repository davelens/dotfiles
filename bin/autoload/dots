#!/usr/bin/env bash
# shellcheck disable=SC2154
set -e

# TODO: Change the `dots` command to git init DOTFILES_REPO_HOME, if necessary.

source "$DOTFILES_CONFIG_HOME"/env

log_file="$DOTFILES_STATE_HOME"/dots.log
[ ! -f "$log_file" ] && touch "$log_file"

usage() {
  echo
  echo "Usage: $(basename "$0") [-h|--help] <command>"
  echo
  echo "Commands:"
  echo "  logs         Opens the logfile in $EDITOR (read-only if applicable)."
  echo "  install      Attempts a (re)install through dotbot."
  echo "  update       Updates dotfiles to the most recent version."
  echo "               Use --dotbot to also update dotbot to latest master."
  echo "  setup        Sets up additional dotfile repositories."
  echo "               Use --dotsys <arch|macos|wsl> to setup davelens/dotsys."
  echo "               Use --dotvim to setup davelens/dotvim."
  echo
  echo "Options:"
  echo "  -h|--help    Show this help message and exit."
  exit
}

logs() {
  if [ ! -s "$log_file" ]; then
    fail "$($print_status -i error "The log file is currently empty.")"
  fi

  if [[ "$EDITOR" == *vim* ]]; then
    winbar='Press "q" to stop reading or "c" to clear the logs'

    $EDITOR \
      -c 'set nomodifiable laststatus=0' \
      -c 'highlight WinBarMsg guifg=#ffcc00 guibg=#44475a gui=bold' \
      -c "lua vim.o.winbar = '%#WinBarMsg#$winbar'" \
      -c 'nnoremap q :q<CR>' \
      -c "nnoremap c :silent !truncate -s 0 '$log_file' \| edit<CR>" \
      -R + "$log_file"
  else
    $EDITOR "$log_file"
  fi
}

install() {
  "$DOTFILES_REPO_HOME/setup/install"
}

update_dotbot() {
  $print_status -nc "Updating dotbot to latest master ..."

  local dotbot_path="$DOTFILES_REPO_HOME/dotbot"

  if git -C "$dotbot_path" fetch origin >/dev/null 2>&1 &&
    git -C "$dotbot_path" checkout origin/master >/dev/null 2>&1; then
    $print_status -i ok "Dotbot updated"
    echo "    Remember to commit the submodule change if you want to keep it."
  else
    $print_status -i error "Failed to update dotbot"
    return 1
  fi
}

setup() {
  local dotsys=""
  local dotvim=0

  # Parse flags
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --dotsys)
      shift
      if [[ $# -eq 0 ]]; then
        $print_status -i error "--dotsys requires a value (arch, macos, or wsl)"
        exit 1
      fi

      case "$1" in
      arch | macos | wsl)
        dotsys="$1"
        ;;
      *)
        $print_status -i error "Invalid dotsys value: $1 (must be arch, macos, or wsl)"
        exit 1
        ;;
      esac
      shift
      ;;
    --dotvim)
      dotvim=1
      shift
      ;;
    *)
      $print_status -i error "Unknown option: $1"
      exit 1
      ;;
    esac
  done

  if [[ -z "$dotsys_flag" && $dotvim -eq 0 ]]; then
    $print_status -i error "At least one of --dotsys or --dotvim is required"
    exit 1
  fi

  local error_occurred=0

  # Setup dotsys configs if requested
  if [[ -n "$dotsys_flag" ]]; then
    local dotsys_path="$REPO_NAMESPACE/davelens/dotsys"

    $print_status -nc "Cloning dotsys repository ..."

    if [[ -d "$dotsys_path" ]]; then
      $print_status -i ok "dotsys already exists at $dotsys_path"
    else
      mkdir -p "$(dirname "$dotsys_path")"
      if git clone https://github.com/davelens/dotsys.git "$dotsys_path" &>>"$log_file"; then
        $print_status -i ok "dotsys cloned successfully"
      else
        $print_status -i error "Failed to clone dotsys"
        error_occurred=1
      fi
    fi

    if [[ $error_occurred -eq 0 ]]; then
      $print_status -nc "Running $dotsys_flag init script ..."
      if "$dotsys_path/$dotsys_flag/init.sh" &>>"$log_file"; then
        $print_status -i ok "$dotsys_flag setup complete"
      else
        $print_status -i error "$dotsys_flag setup failed"
        error_occurred=1
      fi
    fi
  fi

  # Setup dotvim configs if requested
  if [[ $dotvim_flag -eq 1 ]]; then
    local dotvim_path="$REPO_NAMESPACE/davelens/dotvim"

    $print_status -nc "Cloning dotvim repository ..."

    if [[ -d "$dotvim_path" ]]; then
      $print_status -i ok "dotvim already exists at $dotvim_path"
    else
      mkdir -p "$(dirname "$dotvim_path")"
      if git clone https://github.com/davelens/dotvim.git "$dotvim_path" &>>"$log_file"; then
        $print_status -i ok "dotvim cloned successfully"
      else
        $print_status -i error "Failed to clone dotvim"
        error_occurred=1
      fi
    fi

    if [[ $error_occurred -eq 0 ]]; then
      $print_status -nc "Running dotvim install script ..."
      if "$dotvim_path/setup/install" &>>"$log_file"; then
        $print_status -i ok "dotvim setup complete"
      else
        $print_status -i error "dotvim setup failed"
        error_occurred=1
      fi
    fi
  fi

  if [[ $error_occurred -ne 0 ]]; then
    echo "    Logs available at $log_file"
    exit 1
  fi
}

update() {
  local update_dotbot_flag=0

  # Parse flags
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --dotbot)
      update_dotbot_flag=1
      shift
      ;;
    *) shift ;;
    esac
  done

  error_occurred=0

  # Check for uncommitted changes and exit gracefully if so.
  if ! git -C "$DOTFILES_REPO_HOME" diff-files --quiet; then
    $print_status -i error "There are uncommitted changes in your dotfiles. Please commit or stash them before updating:"
    echo
    git -C "$DOTFILES_REPO_HOME" st
    exit 1
  fi

  # Update dotbot if requested
  if [ $update_dotbot_flag -eq 1 ]; then
    update_dotbot || error_occurred=1
  fi

  # Pull the latest changes
  $print_status -nc "Pulling in changes ..."

  if git -C "$DOTFILES_REPO_HOME" fetch origin >/dev/null; then
    if ! git -C "$DOTFILES_REPO_HOME" merge --no-commit origin/"$(git -C "$DOTFILES_REPO_HOME" b)" &>>"$log_file"; then
      error_occurred=1
    fi
  else
    error_occurred=1
  fi

  # Run the installer if no errors occurred
  if [ $error_occurred -eq 0 ]; then
    $print_status -i ok "Files updated to latest version"
    $print_status -nc "Running installer ..."
    "$DOTFILES_REPO_HOME/setup/install" &>>"$log_file" || error_occurred=1
  fi

  # Handle final status
  if [ $error_occurred -eq 0 ]; then
    $print_status -i ok "Update complete"
  else
    $print_status -i error "Update failed"
    echo "    Logs available at $log_file"
    exit 1
  fi
}

###############################################################################

main() {
  [ $# -eq 0 ] && usage

  case "$1" in
  -h | --help)
    usage
    ;;
  logs)
    logs
    ;;
  install)
    install
    ;;
  update)
    shift
    update "$@"
    ;;
  setup)
    shift
    setup "$@"
    ;;
  *)
    echo "Unknown command: $1"
    usage
    ;;
  esac
}

main "$@"
