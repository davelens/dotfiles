#!/usr/bin/env bash

# Stops further execution after any error.
set -e
eval "$(source_env)"

main() {
  # Ensure we have at least two arguments
  [[ $# -lt 2 ]] && fail "Usage: $(basename "$0") <category> <command> [<args>...]"

  local category command current_distro current_platform
  category="$1"
  command="$2"
  current_distro="$("$XDG_BIN_HOME/os")"
  current_platform="$("$XDG_BIN_HOME/os" --platform)"

  # Define the base directory for scripts
  BASE_DIR="$DOTFILES_REPO_HOME/bin/utilities"
  SCRIPT_PATH="$BASE_DIR/$category/$command"

  # Platform-specific categories (macos, linux, freebsd, windows)
  case "$category" in
  macos | linux | freebsd | windows)
    [[ "$category" != "$current_platform" ]] && fail "$category utilities only available on $category"
    ;;
  esac

  # Distro-specific categories (arch, debian, nixos, fedora, wsl)
  case "$category" in
  arch | debian | nixos | fedora | wsl)
    [[ "$category" != "$current_distro" ]] && fail "$category utilities only available on $category"
    ;;
  esac

  # Shift off category and command, leaving any remaining arguments
  shift 2

  # Check if the script exists and is executable
  if [ -x "$SCRIPT_PATH" ]; then
    "$SCRIPT_PATH" "$@" # Execute the script with remaining arguments
  else
    echo "Error: Script '$command' not found in '$BASE_DIR/$category' or not executable."
    exit 1
  fi
}

main "$@"
