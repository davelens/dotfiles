#!/usr/bin/env bash

# Creates ~/.ssh/config if it doesn't exist and adds an Include directive
# to load SSH configs from the dotfiles repository.

SSH_CONFIG="$HOME"/.ssh/config
INCLUDE_LINE="Include ${DOTFILES_REPO_HOME/$HOME/\~}/config/ssh/*"

# Ensure ~/.ssh directory exists with proper permissions
if [ ! -d "$HOME"/.ssh ]; then
  mkdir -p "$HOME"/.ssh
  chmod 700 "$HOME"/.ssh
fi

if [ ! -f "$SSH_CONFIG" ]; then
  echo "# Include generated by my dotfiles' setup/ssh script on $(date)" >"$SSH_CONFIG"
  echo "$INCLUDE_LINE" >>"$SSH_CONFIG"
  chmod 600 "$SSH_CONFIG"
  echo "Created $SSH_CONFIG with Include directive."
elif ! grep -qF "$INCLUDE_LINE" "$SSH_CONFIG"; then
  # Prepend the Include line if it's not already present
  echo -e "# Include generated by my dotfiles' setup/ssh script on $(date)\n$INCLUDE_LINE\n\n$(cat "$SSH_CONFIG")" >"$SSH_CONFIG"
  echo "Added Include directive to $SSH_CONFIG."
else
  echo "Include directive already present in $SSH_CONFIG."
fi
